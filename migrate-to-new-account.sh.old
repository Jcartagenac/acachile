#!/bin/bash

# ============================================================
# MIGRACIÃ“N COMPLETA A NUEVA CUENTA CLOUDFLARE
# Script simplificado y funcional
# ============================================================

set -e

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

print_header() {
    echo -e "\n${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
    echo -e "${BLUE}  $1${NC}"
    echo -e "${BLUE}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}\n"
}

print_success() { echo -e "${GREEN}âœ“ $1${NC}"; }
print_error() { echo -e "${RED}âœ— $1${NC}"; }
print_warning() { echo -e "${YELLOW}âš  $1${NC}"; }
print_info() { echo -e "${BLUE}â„¹ $1${NC}"; }

confirm() {
    read -p "$1 (y/n): " -n 1 -r
    echo
    [[ $REPLY =~ ^[Yy]$ ]]
}

# ============================================================
# PASO 1: VERIFICACIÃ“N INICIAL
# ============================================================

print_header "PASO 1: VerificaciÃ³n de cuenta ACTUAL"

print_info "Verificando autenticaciÃ³n..."
if ! wrangler whoami &> /dev/null; then
    print_error "No estÃ¡s autenticado"
    exit 1
fi

echo ""
wrangler whoami
echo ""

if ! confirm "Â¿Es esta la cuenta ACTUAL (origen)?"; then
    print_error "AutentÃ­cate en la cuenta correcta"
    exit 1
fi

# ============================================================
# PASO 2: RECORDATORIO DE SECRETS
# ============================================================

print_header "PASO 2: VerificaciÃ³n de Secrets"

print_warning "CRÃTICO: NecesitarÃ¡s estos valores para la nueva cuenta:"
echo ""
echo "  â€¢ RESEND_API_KEY"
echo "  â€¢ GOOGLE_MAPS_API_KEY"
echo ""

if ! confirm "Â¿Tienes estos valores guardados?"; then
    print_error "GuÃ¡rdalos antes de continuar"
    exit 1
fi

# ============================================================
# PASO 3: EXPORTACIÃ“N (Ya completada)
# ============================================================

print_header "PASO 3: Verificando ExportaciÃ³n"

if [ ! -d "./cloudflare-export/database/sql-dumps" ]; then
    print_warning "No se encontrÃ³ exportaciÃ³n de base de datos"
    print_info "Ejecutando exportaciÃ³n..."
    ./export-db-complete-v2.sh
fi

print_success "ExportaciÃ³n de base de datos verificada"

# Contar archivos SQL
sql_count=$(ls -1 ./cloudflare-export/database/sql-dumps/*.sql 2>/dev/null | wc -l)
print_info "Archivos SQL listos: $sql_count"

# ============================================================
# PASO 4: CAMBIO DE CUENTA
# ============================================================

print_header "PASO 4: Cambio a Nueva Cuenta"

print_warning "Vas a cerrar sesiÃ³n en la cuenta actual"
echo ""

if ! confirm "Â¿Continuar?"; then
    print_error "MigraciÃ³n cancelada"
    exit 1
fi

print_info "Cerrando sesiÃ³n..."
wrangler logout

print_info "Abriendo navegador para login..."
print_warning "âš ï¸  IMPORTANTE: Inicia sesiÃ³n con la cuenta NUEVA (destino)"
echo ""
sleep 2

wrangler login

echo ""
print_info "Verificando nueva cuenta..."
wrangler whoami
echo ""

if ! confirm "Â¿Es esta la cuenta NUEVA (destino)?"; then
    print_error "Cuenta incorrecta"
    exit 1
fi

print_success "Cambio de cuenta completado"

# Guardar Account ID
NEW_ACCOUNT_ID=$(wrangler whoami | grep "Account ID" | awk '{print $NF}' | tr -d 'â”‚ ')
echo "$NEW_ACCOUNT_ID" > ./cloudflare-export/new-account-id.txt

# ============================================================
# PASO 5: CREAR D1 DATABASE
# ============================================================

print_header "PASO 5: Creando D1 Database"

DB_NAME="acachile-db"

print_info "Creando database: $DB_NAME"

# Crear database
NEW_DB_OUTPUT=$(wrangler d1 create "$DB_NAME" 2>&1)
echo "$NEW_DB_OUTPUT"

# Extraer el ID
NEW_DB_ID=$(echo "$NEW_DB_OUTPUT" | grep -o "database_id = \"[^\"]*\"" | cut -d'"' -f2)

if [ -z "$NEW_DB_ID" ]; then
    print_error "No se pudo obtener el ID de la database"
    exit 1
fi

print_success "Database creada: $NEW_DB_ID"
echo "$NEW_DB_ID" > ./cloudflare-export/new-db-id.txt

# ============================================================
# PASO 6: APLICAR ESQUEMAS
# ============================================================

print_header "PASO 6: Aplicando Esquemas de Base de Datos"

print_info "Aplicando migraciones SQL..."

# Aplicar esquemas en orden
SCHEMAS=(
    "socios-cuotas-schema.sql"
    "eventos-schema.sql"
    "005_create_comunicados.sql"
    "006_create_eventos.sql"
)

for schema in "${SCHEMAS[@]}"; do
    schema_file="./cloudflare-export/migrations-sql/$schema"
    if [ -f "$schema_file" ]; then
        print_info "Aplicando: $schema"
        wrangler d1 execute "$DB_NAME" --remote --file="$schema_file" || print_warning "Error en $schema (puede ser normal si ya existe)"
    fi
done

print_success "Esquemas aplicados"

# ============================================================
# PASO 7: IMPORTAR DATOS
# ============================================================

print_header "PASO 7: Importando Datos"

print_info "Importando datos a la nueva database..."

# Orden de importaciÃ³n (respetando foreign keys)
IMPORT_ORDER=(
    "usuarios"
    "roles_catalog"
    "configuracion_global"
    "user_privacy_settings"
    "users"
    "cuotas"
    "generacion_cuotas"
    "pagos"
    "eventos"
    "events"
    "inscriptions"
    "news_categories"
    "news_tags"
    "news_articles"
    "news_comments"
    "postulaciones"
    "site_sections"
)

for table in "${IMPORT_ORDER[@]}"; do
    sql_file="./cloudflare-export/database/sql-dumps/${table}.sql"
    
    if [ -f "$sql_file" ]; then
        print_info "Importando: $table"
        if wrangler d1 execute "$DB_NAME" --remote --file="$sql_file" 2>&1 | grep -q "success"; then
            print_success "$table importado"
        else
            print_warning "$table: puede tener errores (verificar despuÃ©s)"
        fi
    fi
done

print_success "Datos importados"

# Verificar
print_info "Verificando datos..."
wrangler d1 execute "$DB_NAME" --remote \
    --command="SELECT COUNT(*) as total_usuarios FROM usuarios" \
    --json | jq -r '.[0].results[0].total_usuarios' > /tmp/user_count.txt

user_count=$(cat /tmp/user_count.txt)
print_info "Usuarios importados: $user_count"

# ============================================================
# PASO 8: CREAR R2 BUCKET
# ============================================================

print_header "PASO 8: Creando R2 Bucket"

BUCKET_NAME="aca-chile-images"

print_info "Creando bucket: $BUCKET_NAME"
wrangler r2 bucket create "$BUCKET_NAME" || print_warning "Bucket ya existe o error al crear"

print_success "R2 Bucket configurado"

# Configurar CORS
print_info "Configurando CORS..."
cat > /tmp/r2-cors.json << 'CORS_EOF'
{
  "AllowedOrigins": ["*"],
  "AllowedMethods": ["GET", "HEAD"],
  "AllowedHeaders": ["*"],
  "MaxAgeSeconds": 3600
}
CORS_EOF

# CORS se configura manualmente en el dashboard si es necesario

# ============================================================
# PASO 9: CREAR KV NAMESPACES
# ============================================================

print_header "PASO 9: Creando KV Namespaces"

print_info "Creando KV namespace: ACA_KV"
KV_OUTPUT=$(wrangler kv namespace create "ACA_KV" 2>&1)
echo "$KV_OUTPUT"

NEW_KV_ID=$(echo "$KV_OUTPUT" | grep -o "id = \"[^\"]*\"" | head -1 | cut -d'"' -f2)

if [ -n "$NEW_KV_ID" ]; then
    print_success "KV creado: $NEW_KV_ID"
    echo "$NEW_KV_ID" > ./cloudflare-export/new-kv-id.txt
else
    print_error "Error al crear KV namespace"
fi

print_info "Creando KV preview namespace..."
KV_PREVIEW_OUTPUT=$(wrangler kv namespace create "ACA_KV_preview" 2>&1)
echo "$KV_PREVIEW_OUTPUT"

NEW_KV_PREVIEW_ID=$(echo "$KV_PREVIEW_OUTPUT" | grep -o "id = \"[^\"]*\"" | head -1 | cut -d'"' -f2)

if [ -n "$NEW_KV_PREVIEW_ID" ]; then
    print_success "KV Preview creado: $NEW_KV_PREVIEW_ID"
    echo "$NEW_KV_PREVIEW_ID" > ./cloudflare-export/new-kv-preview-id.txt
fi

# ============================================================
# PASO 10: GENERAR NUEVO WRANGLER.TOML
# ============================================================

print_header "PASO 10: Generando ConfiguraciÃ³n Actualizada"

cat > ./frontend/wrangler.toml.new << WRANGLER_EOF
name = "acachile"
compatibility_date = "2024-09-23"
compatibility_flags = ["nodejs_compat"]
pages_build_output_dir = "dist"

# Bindings para Pages Functions
[[d1_databases]]
binding = "DB"
database_name = "$DB_NAME"
database_id = "$NEW_DB_ID"

[[kv_namespaces]]
binding = "ACA_KV"
id = "$NEW_KV_ID"
preview_id = "$NEW_KV_PREVIEW_ID"

# R2 bucket para imÃ¡genes
[[r2_buckets]]
binding = "IMAGES"
bucket_name = "$BUCKET_NAME"

[env.production.vars]
ENVIRONMENT = "production"
CORS_ORIGIN = "https://acachile.pages.dev"
FRONTEND_URL = "https://acachile.pages.dev"
FROM_EMAIL = "noreply@mail.juancartagena.cl"
ADMIN_EMAIL = "admin@acachile.cl"

[env.preview.vars]
ENVIRONMENT = "preview"
CORS_ORIGIN = "*"
FRONTEND_URL = "https://acachile.pages.dev"
FROM_EMAIL = "noreply@mail.juancartagena.cl"
ADMIN_EMAIL = "admin@acachile.cl"

# Bindings especÃ­ficas para producciÃ³n
[[env.production.kv_namespaces]]
binding = "ACA_KV"
id = "$NEW_KV_ID"

[[env.production.d1_databases]]
binding = "DB"
database_name = "$DB_NAME"
database_id = "$NEW_DB_ID"

[[env.production.r2_buckets]]
binding = "IMAGES"
bucket_name = "$BUCKET_NAME"

# Bindings especÃ­ficas para preview
[[env.preview.kv_namespaces]]
binding = "ACA_KV"
id = "$NEW_KV_ID"

[[env.preview.d1_databases]]
binding = "DB"
database_name = "$DB_NAME"
database_id = "$NEW_DB_ID"

[[env.preview.r2_buckets]]
binding = "IMAGES"
bucket_name = "$BUCKET_NAME"
WRANGLER_EOF

print_success "ConfiguraciÃ³n generada: frontend/wrangler.toml.new"

# Aplicar automÃ¡ticamente
print_info "Aplicando nueva configuraciÃ³n..."
cp ./frontend/wrangler.toml ./frontend/wrangler.toml.old
cp ./frontend/wrangler.toml.new ./frontend/wrangler.toml
print_success "wrangler.toml actualizado"

# ============================================================
# PASO 11: RESUMEN Y PRÃ“XIMOS PASOS
# ============================================================

print_header "MIGRACIÃ“N COMPLETADA âœ…"

cat << SUMMARY_EOF

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         RECURSOS CREADOS EN NUEVA CUENTA               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âœ“ D1 Database: $DB_NAME
  ID: $NEW_DB_ID
  Datos importados: $user_count usuarios + todas las tablas

âœ“ R2 Bucket: $BUCKET_NAME
  Estado: Creado (sin imÃ¡genes aÃºn)

âœ“ KV Namespace: ACA_KV
  ID: $NEW_KV_ID
  Preview ID: $NEW_KV_PREVIEW_ID

âœ“ ConfiguraciÃ³n: frontend/wrangler.toml
  Estado: Actualizado con nuevos IDs

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              PRÃ“XIMOS PASOS MANUALES                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

1ï¸âƒ£  CONFIGURAR SECRETS:
   
   cd frontend
   wrangler pages secret put RESEND_API_KEY --project-name=acachile
   wrangler pages secret put GOOGLE_MAPS_API_KEY --project-name=acachile

2ï¸âƒ£  MIGRAR IMÃGENES R2 (Opcional - Rclone):
   
   Las imÃ¡genes NO se migraron automÃ¡ticamente.
   Opciones:
   a) Usar Rclone (recomendado): ./setup-rclone.sh
   b) MigraciÃ³n manual desde dashboard
   c) Re-subir imÃ¡genes desde aplicaciÃ³n

3ï¸âƒ£  DESPLEGAR APLICACIÃ“N:
   
   cd frontend
   npm install
   npm run build
   npm run deploy

4ï¸âƒ£  VERIFICAR DEPLOYMENT:
   
   curl https://acachile.pages.dev/api/health | jq .

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                ARCHIVOS IMPORTANTES                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ðŸ“ cloudflare-export/
   â”œâ”€â”€ new-account-id.txt       # ID de nueva cuenta
   â”œâ”€â”€ new-db-id.txt            # ID de D1 Database
   â”œâ”€â”€ new-kv-id.txt            # ID de KV Namespace
   â”œâ”€â”€ new-kv-preview-id.txt    # ID de KV Preview
   â”œâ”€â”€ wrangler.toml.backup     # Backup de config anterior
   â””â”€â”€ database/
       â”œâ”€â”€ sql-dumps/           # Todos los datos exportados
       â””â”€â”€ import-all-data.sh   # Script de re-importaciÃ³n

ðŸ“„ frontend/
   â”œâ”€â”€ wrangler.toml            # ConfiguraciÃ³n NUEVA (activa)
   â””â”€â”€ wrangler.toml.old        # ConfiguraciÃ³n anterior (backup)

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                   COMANDOS ÃšTILES                      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Verificar cuenta actual
wrangler whoami

# Listar recursos
wrangler d1 list
wrangler r2 bucket list
wrangler kv namespace list

# Verificar datos en D1
wrangler d1 execute $DB_NAME --remote \\
  --command="SELECT COUNT(*) FROM usuarios"

# Generar reporte completo
./generate-migration-report.sh

SUMMARY_EOF

print_success "ðŸŽ‰ MigraciÃ³n completada exitosamente"
print_info "Guarda este resumen en: ./cloudflare-export/MIGRATION_COMPLETED.txt"

# Guardar resumen
cat > ./cloudflare-export/MIGRATION_COMPLETED.txt << COMPLETED_EOF
MigraciÃ³n completada: $(date)

Nueva cuenta ID: $NEW_ACCOUNT_ID
Database ID: $NEW_DB_ID
KV Namespace ID: $NEW_KV_ID
KV Preview ID: $NEW_KV_PREVIEW_ID
R2 Bucket: $BUCKET_NAME

PrÃ³ximos pasos: Configurar secrets y desplegar
COMPLETED_EOF

print_info "Â¡Todo listo! Sigue los prÃ³ximos pasos para completar la migraciÃ³n."
