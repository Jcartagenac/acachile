import{r as c,g as D,j as r,B as S}from"./index-CNdVzGTF.js";const Y=[{key:"home",label:"Inicio"},{key:"about",label:"Quiénes Somos"},{key:"contact",label:"Contacto"}],Z=d=>d==="event"||d==="news"?d:"custom",P=()=>{if(typeof document>"u")return"";const d=document.cookie.match(/(?:^|;\s*)auth_token=([^;]+)/);return d&&d[1]?decodeURIComponent(d[1]):typeof window<"u"&&window.localStorage.getItem("auth_token")||""},A=d=>D(d).map(n=>({...n})),O=(d,n)=>{const u=new Map(D(d).map(s=>[s.key,s])),h=new Map;(n||[]).forEach((s,x)=>{var v;const f=typeof(s==null?void 0:s.key)=="string"&&s.key.trim().length>0?s.key.trim():((v=D(d)[x])==null?void 0:v.key)??`section_${x}`,l=u.get(f),C=typeof(s==null?void 0:s.sort_order)=="number"?s.sort_order:(l==null?void 0:l.sort_order)??x;h.set(f,{page:d,key:f,title:typeof(s==null?void 0:s.title)=="string"?s.title:(l==null?void 0:l.title)??"",content:typeof(s==null?void 0:s.content)=="string"?s.content:(l==null?void 0:l.content)??"",image_url:typeof(s==null?void 0:s.image_url)=="string"?s.image_url:(l==null?void 0:l.image_url)??"",sort_order:C,source_type:Z((s==null?void 0:s.source_type)??(l==null?void 0:l.source_type)),source_id:typeof(s==null?void 0:s.source_id)=="string"?s.source_id:typeof(l==null?void 0:l.source_id)=="string"?l.source_id:void 0,cta_label:typeof(s==null?void 0:s.cta_label)=="string"?s.cta_label:typeof(l==null?void 0:l.cta_label)=="string"?l.cta_label:void 0,cta_url:typeof(s==null?void 0:s.cta_url)=="string"?s.cta_url:typeof(l==null?void 0:l.cta_url)=="string"?l.cta_url:void 0}),u.delete(f)});for(const s of u.values())h.set(s.key,{...s});return Array.from(h.values()).sort((s,x)=>s.sort_order-x.sort_order)},K=(d,n)=>n.map((u,h)=>{var s,x;return{page:d,key:u.key,title:u.title.trim(),content:u.content,image_url:u.image_url,sort_order:typeof u.sort_order=="number"?u.sort_order:h,source_type:u.source_type??"custom",source_id:u.source_id,cta_label:((s=u.cta_label)==null?void 0:s.trim())||void 0,cta_url:((x=u.cta_url)==null?void 0:x.trim())||void 0}}).sort((u,h)=>u.sort_order-h.sort_order);function te({initialPage:d="home"}){const[n,u]=c.useState(d),[h,s]=c.useState(A("home")),[x,f]=c.useState(!0),[l,C]=c.useState(!1),[v,H]=c.useState(!1),[_,R]=c.useState(0),[T,B]=c.useState({}),[I,k]=c.useState({}),[b,M]=c.useState([]),[j,z]=c.useState([]),[U,F]=c.useState(!1);c.useEffect(()=>{u(d)},[d]),c.useEffect(()=>{let e=!0;return(async()=>{f(!0);try{const t=await(await fetch(`/api/admin/content?page=${n}`,{cache:"no-store"})).json();e&&(t!=null&&t.success)?s(O(n,t.sections)):e&&s(A(n))}catch(a){console.error("[AdminHomeEditor] fetchSections error:",a),e&&s(A(n))}finally{e&&f(!1)}})(),()=>{e=!1}},[n]),c.useEffect(()=>{n!=="home"||U||(async()=>{try{const[e,a]=await Promise.all([fetch("/api/eventos?status=published&limit=100",{cache:"no-store"}).then(t=>t.json()).catch(()=>({success:!1})),fetch("/api/noticias?limit=100",{cache:"no-store"}).then(t=>t.json()).catch(()=>({success:!1}))]);e!=null&&e.success&&Array.isArray(e.data)&&M(e.data),a!=null&&a.success&&Array.isArray(a.data)&&z(a.data)}finally{F(!0)}})()},[n,U]);const V=c.useMemo(()=>[...h].sort((e,a)=>e.sort_order-a.sort_order),[h]),g=c.useCallback((e,a,t)=>{s(o=>o.map(i=>i.key===e?{...i,[a]:t}:i))},[]),$=c.useCallback((e,a)=>{const t=b.find(i=>String(i.id)===a);if(!t){g(e,"source_id",void 0);return}const o=[];if(t.description&&o.push(t.description),t.date){const i=new Date(t.date).toLocaleDateString("es-CL",{year:"numeric",month:"long",day:"numeric"});o.push(`Fecha: ${i}`)}t.location&&o.push(`Lugar: ${t.location}`),t.registrationOpen&&o.push("Inscripciones abiertas"),s(i=>i.map(m=>m.key===e?{...m,source_type:"event",source_id:a,title:t.title||m.title,content:o.filter(Boolean).join(`

`)||m.content,image_url:t.image||m.image_url,cta_label:m.cta_label||"Ver evento",cta_url:`/eventos/${t.id}`}:m))},[b,g]),L=c.useCallback((e,a)=>{const t=j.find(i=>i.slug===a);if(!t){g(e,"source_id",void 0);return}const o=t.excerpt||t.content||"";s(i=>i.map(m=>m.key===e?{...m,source_type:"news",source_id:a,title:t.title||m.title,content:o,image_url:t.featured_image||m.image_url,cta_label:m.cta_label||"Leer noticia",cta_url:`/noticias/${t.slug}`}:m))},[j,g]),G=c.useCallback((e,a)=>{s(t=>t.map(o=>o.key===e?{...o,source_type:a,source_id:a==="custom"?void 0:o.source_id}:o)),a==="event"&&b[0]&&$(e,String(b[0].id)),a==="news"&&j[0]&&L(e,j[0].slug)},[b,j,$,L]),q=c.useCallback(async()=>{C(!0);try{const e=P(),a=K(n,h),o=await(await fetch(`/api/admin/content?page=${n}`,{method:"POST",headers:{"Content-Type":"application/json",...e?{Authorization:`Bearer ${e}`}:{}},body:JSON.stringify({sections:a})})).json();o.success?(alert("Secciones guardadas correctamente"),s(O(n,o.sections))):alert(o.error||"No se pudo guardar la información")}catch(e){console.error("[AdminHomeEditor] save error:",e),alert("Error guardando")}finally{C(!1)}},[h,n]),w=c.useCallback(async(e,a)=>{if(!a)return;R(o=>o+1),k(o=>({...o,[e]:""}));const t=new FileReader;t.onload=()=>{g(e,"image_url",String(t.result))},t.readAsDataURL(a);try{const o=P(),i=new FormData;i.append("file",a),i.append("folder",n==="home"?"home":"content"),i.append("filename",a.name),await new Promise((m,E)=>{const y=new XMLHttpRequest;y.open("POST","/api/admin/content/upload"),o&&y.setRequestHeader("Authorization",`Bearer ${o}`),y.upload.onprogress=p=>{if(p.lengthComputable){const N=Math.round(p.loaded/p.total*100);B(X=>({...X,[e]:N}))}},y.onload=()=>{if(y.status>=200&&y.status<300)try{const p=JSON.parse(y.responseText);p.success&&p.url?(g(e,"image_url",p.url),m()):(k(N=>({...N,[e]:p.error||"Error subida"})),E(new Error(p.error||"Upload failed")))}catch(p){k(N=>({...N,[e]:"Respuesta inválida"})),E(p)}else k(p=>({...p,[e]:`HTTP ${y.status}`})),E(new Error(`HTTP ${y.status}`))},y.onerror=()=>{k(p=>({...p,[e]:"Error de red"})),E(new Error("Network error"))},y.send(i)})}catch(o){console.error("[AdminHomeEditor] uploadImage error:",o)}finally{B(o=>({...o,[e]:0})),R(o=>Math.max(0,o-1))}},[g,n]),J=c.useCallback(async()=>{H(!0);try{const e=P(),t=await(await fetch(`/api/admin/content/clear_cache?page=${n}`,{method:"POST",headers:e?{Authorization:`Bearer ${e}`}:void 0})).json();t.success?alert("Cache KV borrado"):alert(t.error||"No se pudo borrar cache")}catch(e){console.error("[AdminHomeEditor] clearCache error:",e),alert("Error al borrar cache")}finally{H(!1)}},[n]),Q=c.useCallback(()=>{const e=h.length,a={page:n,key:`section_${Date.now()}`,title:`Nueva sección ${e+1}`,content:"",image_url:"",sort_order:e,source_type:"custom"};s(t=>[...t,a])},[h.length,n]),W=c.useCallback(()=>{window.confirm("¿Restablecer las secciones a los valores por defecto?")&&s(A(n))},[n]);return r.jsxs("div",{className:"p-6 bg-white rounded-lg shadow-sm space-y-6",children:[r.jsx("div",{className:"flex flex-wrap gap-2",children:Y.map(e=>r.jsx(S,{variant:e.key===n?"primary":"outline",onClick:()=>u(e.key),disabled:l||_>0||v,children:e.label},e.key))}),x?r.jsx("div",{children:"Cargando..."}):r.jsxs("div",{className:"space-y-4",children:[V.map((e,a)=>r.jsxs("div",{className:"border p-4 rounded space-y-3",children:[r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("p",{className:"text-sm font-semibold text-gray-700",children:e.key?`${e.key}`:`Sección ${a+1}`}),r.jsxs("div",{className:"flex items-center gap-2",children:[r.jsx("label",{className:"text-xs text-gray-500",children:"Orden"}),r.jsx("input",{type:"number",value:e.sort_order??a,onChange:t=>g(e.key,"sort_order",Number(t.target.value)),className:"w-20 border rounded px-2 py-1 text-sm"})]})]}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium",children:"Contenido basado en"}),r.jsxs("select",{value:e.source_type??"custom",onChange:t=>G(e.key,t.target.value),className:"w-full border rounded px-2 py-1",disabled:n!=="home",children:[r.jsx("option",{value:"custom",children:"Contenido manual"}),r.jsx("option",{value:"event",children:"Evento destacado"}),r.jsx("option",{value:"news",children:"Noticia destacada"})]})]}),n==="home"&&e.source_type==="event"&&r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium",children:"Selecciona evento"}),r.jsxs("select",{value:e.source_id??"",onChange:t=>$(e.key,t.target.value),className:"w-full border rounded px-2 py-1",children:[r.jsx("option",{value:"",children:"-- selecciona --"}),b.map(t=>r.jsx("option",{value:String(t.id),children:t.title},t.id))]})]}),n==="home"&&e.source_type==="news"&&r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium",children:"Selecciona noticia"}),r.jsxs("select",{value:e.source_id??"",onChange:t=>L(e.key,t.target.value),className:"w-full border rounded px-2 py-1",children:[r.jsx("option",{value:"",children:"-- selecciona --"}),j.map(t=>r.jsx("option",{value:t.slug,children:t.title},t.id))]})]})]}),r.jsx("label",{className:"block text-sm font-medium",children:"Título"}),r.jsx("input",{value:e.title||"",onChange:t=>g(e.key,"title",t.target.value),className:"w-full border rounded px-2 py-1",placeholder:"Título de la sección"}),r.jsx("label",{className:"block text-sm font-medium mt-2",children:"Imagen (URL)"}),r.jsx("input",{value:e.image_url||"",onChange:t=>g(e.key,"image_url",t.target.value),className:"w-full border rounded px-2 py-1",placeholder:"https://..."}),r.jsxs("div",{className:"flex items-center space-x-2 mb-2",children:[r.jsx("input",{type:"file",accept:"image/*",onChange:t=>{var i;const o=(i=t.target.files)==null?void 0:i[0];o&&w(e.key,o)}}),r.jsx("span",{className:"text-sm text-gray-500",children:"o pega una URL arriba"})]}),e.image_url?r.jsx("div",{className:"mb-2",children:r.jsx("img",{src:e.image_url,alt:"preview",style:{maxHeight:120},className:"rounded"})}):null,T[e.key]?r.jsxs("div",{className:"mb-2",children:[r.jsx("div",{className:"w-full bg-gray-200 rounded h-2",children:r.jsx("div",{style:{width:`${T[e.key]}%`},className:"bg-blue-500 h-2 rounded"})}),r.jsxs("div",{className:"text-xs text-gray-600",children:[T[e.key],"%"]})]}):null,I[e.key]?r.jsx("div",{className:"text-sm text-red-600",children:I[e.key]}):null,r.jsx("label",{className:"block text-sm font-medium",children:"Contenido"}),r.jsx("textarea",{value:e.content||"",onChange:t=>g(e.key,"content",t.target.value),className:"w-full border rounded px-2 py-1 mb-2",rows:n==="contact"?6:4}),r.jsxs("div",{className:"grid grid-cols-1 sm:grid-cols-2 gap-3",children:[r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium",children:"Texto del botón"}),r.jsx("input",{value:e.cta_label||"",onChange:t=>g(e.key,"cta_label",t.target.value),className:"w-full border rounded px-2 py-1",placeholder:"Ej: Ver evento"})]}),r.jsxs("div",{children:[r.jsx("label",{className:"block text-sm font-medium",children:"URL del botón"}),r.jsx("input",{value:e.cta_url||"",onChange:t=>g(e.key,"cta_url",t.target.value),className:"w-full border rounded px-2 py-1",placeholder:"https://..."})]})]})]},e.key||a)),r.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[r.jsx(S,{onClick:q,className:"bg-red-600 text-white",disabled:l||_>0,children:l?"Guardando…":"Guardar secciones"}),r.jsx(S,{onClick:J,className:"bg-gray-600 text-white",disabled:v||_>0,children:v?"Borrando cache…":"Borrar cache KV"}),r.jsx(S,{onClick:Q,className:"bg-blue-600 text-white",disabled:_>0,children:"Agregar sección"}),r.jsx(S,{onClick:W,variant:"secondary",disabled:_>0,children:"Restaurar por defecto"}),_>0&&r.jsxs("div",{className:"text-sm text-gray-600",children:["Subiendo imágenes… (",_,")"]})]})]})]})}export{te as default};
