# ğŸš€ MIGRACIÃ“N A CLOUDFLARE PAGES FUNCTIONS - PLAN DE SPRINTS

## ğŸ“‹ CONTEXTO
Migrar el backend actual de Cloudflare Workers a Cloudflare Pages Functions para unificar frontend y backend en una sola aplicaciÃ³n de Pages.

### ğŸ¯ OBJETIVO
- âœ… Mantener toda la funcionalidad existente
- âœ… Unificar deployment en Cloudflare Pages  
- âœ… Simplificar arquitectura y desarrollo
- âœ… Mantener compatibilidad con D1, KV, Resend, etc.

## ğŸ—ï¸ ARQUITECTURA ACTUAL vs NUEVA

### ACTUAL (Workers)
```
- frontend/ (Pages)
- worker/ (Worker separado)
- shared/ (Types compartidos)
```

### NUEVA (Pages Functions)
```
- frontend/
  - src/ (React app)
  - functions/ (Backend API)
  - shared/ (Types compartidos)
```

---

## ğŸ¯ SPRINT 1: CONFIGURACIÃ“N BASE Y AUTH
**Objetivo**: Migrar autenticaciÃ³n y configurar base de Pages Functions

### âœ… TAREAS SPRINT 1:
- [ ] Crear estructura `/functions` en frontend
- [ ] Configurar TypeScript para functions
- [ ] Configurar bindings (D1, KV, variables de entorno)
- [ ] Migrar autenticaciÃ³n (login/register/forgot-password)
- [ ] Migrar middleware de CORS y auth
- [ ] Configurar rutas de auth: `/api/auth/*`
- [ ] Testing de funciones auth

### ğŸ“ ESTRUCTURA SPRINT 1:
```
frontend/
â”œâ”€â”€ functions/
â”‚   â”œâ”€â”€ types.d.ts
â”‚   â”œâ”€â”€ tsconfig.json
â”‚   â”œâ”€â”€ _middleware.ts
â”‚   â””â”€â”€ api/
â”‚       â””â”€â”€ auth/
â”‚           â”œâ”€â”€ login.ts
â”‚           â”œâ”€â”€ register.ts
â”‚           â”œâ”€â”€ forgot-password.ts
â”‚           â”œâ”€â”€ reset-password.ts
â”‚           â””â”€â”€ change-password.ts
```

---

## ğŸ¯ SPRINT 2: EVENTOS Y INSCRIPCIONES  
**Objetivo**: Migrar gestiÃ³n completa de eventos

### âœ… TAREAS SPRINT 2:
- [ ] Migrar servicios de eventos
- [ ] Migrar handlers de eventos CRUD
- [ ] Migrar sistema de inscripciones
- [ ] Configurar rutas: `/api/eventos/*` y `/api/inscripciones/*`
- [ ] Testing de eventos e inscripciones

### ğŸ“ ESTRUCTURA SPRINT 2:
```
frontend/functions/api/
â”œâ”€â”€ eventos/
â”‚   â”œâ”€â”€ index.ts (GET /api/eventos)
â”‚   â”œâ”€â”€ [id].ts (GET/PUT/DELETE /api/eventos/:id)
â”‚   â””â”€â”€ init.ts (POST /api/eventos/init)
â””â”€â”€ inscripciones/
    â”œâ”€â”€ index.ts (GET /api/inscripciones)
    â”œâ”€â”€ [id].ts (POST/DELETE /api/inscripciones/:id)
    â””â”€â”€ mis-inscripciones.ts
```

---

## ğŸ¯ SPRINT 3: NOTICIAS Y BÃšSQUEDA
**Objetivo**: Migrar sistema de noticias y bÃºsqueda

### âœ… TAREAS SPRINT 3:
- [ ] Migrar servicios de noticias
- [ ] Migrar handlers de noticias CRUD
- [ ] Migrar sistema de bÃºsqueda
- [ ] Migrar sistema de comentarios
- [ ] Configurar rutas: `/api/news/*`, `/api/search/*`, `/api/comments/*`
- [ ] Testing de funcionalidades

### ğŸ“ ESTRUCTURA SPRINT 3:
```
frontend/functions/api/
â”œâ”€â”€ news/
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ [slug].ts
â”‚   â””â”€â”€ admin/
â”œâ”€â”€ search/
â”‚   â”œâ”€â”€ index.ts
â”‚   â””â”€â”€ suggestions.ts
â””â”€â”€ comments/
    â”œâ”€â”€ index.ts
    â””â”€â”€ [id].ts
```

---

## ğŸ¯ SPRINT 4: ADMIN Y LIMPIEZA
**Objetivo**: Migrar panel admin y finalizar migraciÃ³n

### âœ… TAREAS SPRINT 4:
- [ ] Migrar servicios de administraciÃ³n
- [ ] Migrar handlers de admin
- [ ] Migrar gestiÃ³n de usuarios
- [ ] Configurar rutas: `/api/admin/*`
- [ ] Crear `_routes.json` para optimizar invocaciones
- [ ] Testing completo del sistema
- [ ] Deprecar Worker original
- [ ] DocumentaciÃ³n de la nueva arquitectura

### ğŸ“ ESTRUCTURA SPRINT 4:
```
frontend/functions/api/
â””â”€â”€ admin/
    â”œâ”€â”€ users/
    â”‚   â”œâ”€â”€ index.ts
    â”‚   â””â”€â”€ [id].ts
    â”œâ”€â”€ dashboard.ts
    â””â”€â”€ stats.ts
```

---

## ğŸ”§ CONFIGURACIÃ“N TÃ‰CNICA

### Bindings Necesarios:
- **D1**: Base de datos (`ACA_DB`)
- **KV**: Cache y storage (`ACA_KV`) 
- **Variables**: JWT_SECRET, ADMIN_EMAIL, etc.
- **Secrets**: RESEND_API_KEY

### TypeScript Config:
```json
{
  "compilerOptions": {
    "target": "esnext",
    "module": "esnext", 
    "lib": ["esnext"],
    "types": ["./types.d.ts"]
  }
}
```

### Wrangler Config (functions/wrangler.toml):
```toml
compatibility_flags = ["nodejs_compat"]
compatibility_date = "2024-09-23"

[[d1_databases]]
binding = "DB"
database_name = "aca-chile-db"
database_id = "tu-database-id"

[[kv_namespaces]]
binding = "ACA_KV"
id = "tu-kv-id"
```

---

## ğŸ“Š PROGRESO ACTUAL

### âœ… COMPLETADO SPRINT 1:
- âœ… Estructura `/functions` creada
- âœ… TypeScript configurado para functions
- âœ… Bindings configurados (wrangler.toml)
- âœ… Middleware de CORS y auth (_middleware.ts/.js)
- âœ… Sistema de autenticaciÃ³n migrado:
  - âœ… /api/auth/login.ts/.js (FUNCIONANDO)
  - âœ… /api/auth/register.ts
  - âœ… /api/auth/forgot-password.ts
  - âœ… /api/auth/reset-password.ts
  - âœ… /api/auth/change-password.ts
  - âœ… /api/auth/me.ts (GET/PUT perfil)
- âœ… Health check (/api/health.js) - FUNCIONANDO
- âœ… OptimizaciÃ³n con _routes.json
- âœ… Build funcional del frontend
- âœ… **DEPLOY EXITOSO A CLOUDFLARE PAGES**
- âœ… **Functions detectadas y funcionando**
- âœ… **URL del proyecto: https://a5b2899e.acachile-frontend.pages.dev**

ğŸ¯ **SOLUCIÃ“N TÃ‰CNICA ENCONTRADA:**
- Pages Functions requiere JavaScript, no TypeScript directo
- Desarrollo local tiene limitaciones, pero deploy real funciona perfectamente
- Middleware y endpoints funcionando correctamente en producciÃ³n

### ğŸ”„ EN PROCESO:
- **SPRINT 2**: Eventos y inscripciones (PRÃ“XIMO)

### â³ PENDIENTE:
- Sprint 2: Eventos y inscripciones
- Sprint 3: Noticias y bÃºsqueda  
- Sprint 4: Admin y limpieza

---

## ğŸ“š REFERENCIAS
- [Pages Functions Docs](https://developers.cloudflare.com/pages/functions/)
- [Pages Functions Routing](https://developers.cloudflare.com/pages/functions/routing/)
- [Pages Functions TypeScript](https://developers.cloudflare.com/pages/functions/typescript/)
- [Pages Functions Bindings](https://developers.cloudflare.com/pages/functions/bindings/)

---

## ğŸš¨ NOTAS IMPORTANTES
- Mantener worker original hasta completar migraciÃ³n
- Testear cada sprint antes del siguiente
- Documentar diferencias encontradas
- Backup de configuraciones antes de cambios

**Ãšltima actualizaciÃ³n**: Sprint 1 COMPLETADO âœ… + HERRAMIENTAS DE CONFIGURACIÃ“N
**Logro principal**: Pages Functions con bindings completas + scripts de configuraciÃ³n automÃ¡tica
**URL activa**: https://acachile-frontend.pages.dev (dominio principal)
**Bindings funcionando**: âœ… D1 Database, âœ… KV Storage, âœ… JWT_SECRET, âœ… RESEND_API_KEY
**Herramientas creadas**: âœ… Scripts configuraciÃ³n, âœ… Diagnostics API, âœ… DocumentaciÃ³n completa
**Comandos npm**: setup-bindings, check-bindings, health-check
**Estado**: Sistema completamente operativo con tooling completo
**Siguiente milestone**: Sprint 2 - Eventos y inscripciones